# Funcionalidade de Expans√£o de Pedidos

## Vis√£o Geral

A funcionalidade de expans√£o de pedidos permite que os usu√°rios visualizem os pedidos individuais de cada linha da tabela de vis√£o geral. Quando um usu√°rio clica no √≠cone de olho (üëÅÔ∏è) na coluna "Pedidos", um modal √© aberto mostrando todos os pedidos detalhados daquele cluster/categoria de tr√°fego.

## Como Funciona

### 1. Interface do Usu√°rio
- Na tabela de vis√£o geral, cada linha tem uma coluna "Pedidos"
- Quando h√° pedidos (valor > 0), um √≠cone de download aparece ao lado do n√∫mero
- **Primeiro**: Clique no √≠cone de download para baixar os pedidos
- **Depois**: O √≠cone muda para olho (verde) indicando que os dados est√£o prontos
- **Visualizar**: Clique no √≠cone de olho para abrir o modal com os detalhes

### 2. API Endpoint
A funcionalidade utiliza o endpoint:
```
POST /metrics/orders
```

**Par√¢metros:**
- `start_date`: Data de in√≠cio (YYYY-MM-DD)
- `end_date`: Data de fim (YYYY-MM-DD)
- `table_name`: Nome da tabela
- `traffic_category`: Categoria de tr√°fego (cluster) - **√öltimo Clique N√£o Direto**
- `fs_traffic_category`: Categoria de tr√°fego (cluster) - **Primeiro Clique**
- `limit`: Limite de pedidos (padr√£o: 100)

**Exemplo de requisi√ß√£o - √öltimo Clique N√£o Direto:**
```bash
curl --request POST \
  --url http://localhost:8000/metrics/orders \
  --header 'Authorization: Bearer YOUR_TOKEN' \
  --header 'Content-Type: application/json' \
  --data '{
    "start_date": "2025-08-02",
    "end_date": "2025-08-02",
    "table_name": "gringa",
    "traffic_category": "üü¢ Google Ads",
    "limit": 100
  }'
```

**Exemplo de requisi√ß√£o - Primeiro Clique:**
```bash
curl --request POST \
  --url http://localhost:8000/metrics/orders \
  --header 'Authorization: Bearer YOUR_TOKEN' \
  --header 'Content-Type: application/json' \
  --data '{
    "start_date": "2025-08-02",
    "end_date": "2025-08-02",
    "table_name": "gringa",
    "fs_traffic_category": "üü¢ Google Ads",
    "limit": 100
  }'
```

### 3. Resposta da API
A API retorna um array de pedidos com a seguinte estrutura:
```json
{
  "data": [
    {
      "Horario": "2025-08-02T10:30:00Z",
      "ID_da_Transacao": "#42965",
      "Primeiro_Nome": "keila valerio",
      "Status": "paid",
      "Receita": 6811.76,
      "Canal": "web",
      "Categoria_de_Trafico": "üü¢ Google Ads",
      "Origem": "google",
      "Midia": "cpc",
      "Campanha": "google_cpc_compradoras_pmax_BR",
      "Conteudo": "(not set)",
      "Pagina_de_Entrada": "https://gringa.com.br/",
      "Parametros_de_URL": "utm_source=google&utm_medium=cpc&utm_campaign=google_cpc_compradoras_pmax_BR&gad_source=1&gad_campaignid=17434584383&gbraid=0AAAAACLgR6WoVVPLRvysSRquh27ojpTp6&gclid=EAIaIQobChMI0Nv5x4jtjgMVrEBIAB2OYDCJEAAYASAAEgL97vD_BwE",
      "Categoria_de_Trafico_Primeiro_Clique": "üü¢ Google Ads",
      "Origem_Primeiro_Clique": "google",
      "Midia_Primeiro_Clique": "cpc",
      "Campanha_Primeiro_Clique": "google_cpc_compradoras_pmax_BR",
      "Conteudo_Primeiro_Clique": "(not set)",
      "Pagina_de_Entrada_Primeiro_Clique": "https://gringa.com.br/",
      "Parametros_de_URL_Primeiro_Clique": "utm_source=google&utm_medium=cpc&utm_campaign=google_cpc_compradoras_pmax_BR&gad_source=1&gad_campaignid=17434584383&gbraid=0AAAAACLgR6WoVVPLRvysSRquh27ojpTp6&gclid=EAIaIQobChMI_Jqo0-PsjgMVoKzuAR0oJwm9EAAYASAAEgKFxvD_BwE",
      "Categoria_de_Trafico_Primeiro_Lead": "",
      "Origem_Primeiro_Lead": "",
      "Midia_Primeiro_Lead": "",
      "Campanha_Primeiro_Lead": "",
      "Conteudo_Primeiro_Lead": "",
      "Pagina_de_Entrada_Primeiro_Lead": "",
      "Parametros_de_URL_Primeiro_Lead": ""
    }
  ]
}
```

## Componentes Implementados

### 1. OrdersExpanded.tsx
Componente modal que exibe os pedidos expandidos com:
- Lista de pedidos com detalhes
- Informa√ß√µes do cliente
- Itens de cada pedido
- Status e valores
- Loading states e tratamento de erros
- **Sistema de cache** para melhor performance
- **Carregamento em background** sem bloquear interface
- **Cancelamento de requisi√ß√µes** para evitar race conditions
- **Bot√£o de refresh** para atualiza√ß√£o manual

### 2. Modifica√ß√µes no Dashboard.tsx
- Adicionado estado para controlar o modal
- **Sistema de download primeiro**: Estado para controlar pedidos baixados
- **Estados de download**: Controle de downloads em andamento
- **Fun√ß√£o de download**: Baixa dados antes de exibir
- **Bot√£o din√¢mico**: Download ‚Üí Loading ‚Üí Olho (verde)
- **Suporte a modelos de atribui√ß√£o**: √öltimo Clique N√£o Direto vs Primeiro Clique
- **Par√¢metros din√¢micos**: Usa `traffic_category` ou `fs_traffic_category` conforme modelo
- Integra√ß√£o com o componente OrdersExpanded
- **Tooltip din√¢mico** baseado no estado (baixar/ver)
- **Indicador visual** no bot√£o (download/loading/olho)
- **Cache limpo** quando mudar tabela, datas ou modelo de atribui√ß√£o

### 3. Modifica√ß√µes no api.ts
- Nova interface `OrdersRequest` com suporte a ambos os par√¢metros
- Nova fun√ß√£o `getOrders()` para fazer a requisi√ß√£o √† API
- **Suporte a AbortController** para cancelamento de requisi√ß√µes
- **Par√¢metros opcionais**: `traffic_category` e `fs_traffic_category`

## Estados do Modal

### Loading Inicial
- Spinner de carregamento
- Mensagem "Carregando pedidos..."
- Aviso de que pode levar alguns segundos

### Loading em Background
- Indicador sutil "Atualizando..."
- Dados anteriores permanecem vis√≠veis
- N√£o bloqueia a interface

### Erro
- √çcone de erro
- Mensagem de erro espec√≠fica
- Bot√£o "Tentar novamente"
- Possibilidade de retry

### Vazio
- √çcone de pacote vazio
- Mensagem "Nenhum pedido encontrado"
- Contexto sobre o filtro aplicado

### Sucesso
- Lista de pedidos com detalhes
- Contador de pedidos encontrados
- Informa√ß√µes completas de cada pedido
- Bot√£o de refresh no header

## Funcionalidades do Modal

### Informa√ß√µes Exibidas
- **ID da Transa√ß√£o** (n√∫mero do pedido)
- **Status** (com cores diferenciadas: paid, pending, cancelled, refunded)
- **Receita** (valor total do pedido)
- **Data/Hora** (formata√ß√£o inteligente com fallback para m√∫ltiplos campos)
- **Nome do Cliente** (primeiro nome)
- **Canal** (web, mobile, etc.)

#### üîÑ √öltimo Clique N√£o Direto (Atribui√ß√£o Atual)
- **Categoria de Tr√°fego** (emoji + nome)
- **Origem** (google, facebook, etc.)
- **M√≠dia** (cpc, cpm, etc.)
- **Campanha** (nome espec√≠fico)
- **Conte√∫do** (conte√∫do do an√∫ncio)
- **P√°gina de Entrada** (com link clic√°vel)

#### üéØ Primeiro Clique
- **Categoria de Tr√°fego** (primeira intera√ß√£o)
- **Origem** (primeira fonte)
- **M√≠dia** (primeiro tipo de an√∫ncio)
- **Campanha** (primeira campanha)
- **Conte√∫do** (primeiro conte√∫do)
- **P√°gina de Entrada** (primeira p√°gina)

#### üìû Primeiro Lead (se dispon√≠vel)
- **Categoria de Tr√°fego** (primeiro lead)
- **Origem** (fonte do lead)
- **M√≠dia** (tipo do lead)
- **Campanha** (campanha do lead)
- **Conte√∫do** (conte√∫do do lead)
- **P√°gina de Entrada** (p√°gina do lead)

#### üìä Compara√ß√£o de Atribui√ß√£o
- **Compara√ß√£o visual** entre primeiro e √∫ltimo clique
- **Indicador de diferen√ßa** quando fontes s√£o diferentes
- **Layout lado a lado** para f√°cil compara√ß√£o

- **Par√¢metros da URL** (UTM parameters em formato leg√≠vel)

### Campos de Data Suportados
O sistema tenta automaticamente os seguintes campos de data:
1. `Horario` (campo principal)
2. `Data` (campo alternativo)
3. `created_at` (formato padr√£o)
4. `data_criacao` (formato brasileiro)
5. `timestamp` (timestamp Unix)
6. `data_pedido` (campo espec√≠fico)
7. `data_transacao` (campo espec√≠fico)

### Formata√ß√£o
- **Moeda brasileira** (R$)
- **Data e hora** no formato brasileiro (DD/MM/AAAA HH:MM)
- **N√∫meros formatados** com separadores de milhares
- **Tratamento robusto de datas**: Suporta m√∫ltiplos formatos (ISO, brasileiro, simples)
- **Fallback inteligente**: Se um campo de data estiver vazio, tenta outros campos
- **Debug autom√°tico**: Logs no console para identificar campos de data dispon√≠veis

### Interatividade
- Hover effects nos cards de pedidos
- Bot√£o de fechar no header
- **Scroll interno otimizado** para muitos pedidos
- **Indicador visual** quando h√° mais de 5 pedidos para rolar
- **Scroll suave** para melhor experi√™ncia
- **Filtro de atribui√ß√£o diferente**: Checkbox para mostrar apenas pedidos com atribui√ß√µes diferentes
- **Contador din√¢mico**: Mostra quantos pedidos t√™m atribui√ß√£o diferente
- Responsivo para mobile

## Status dos Pedidos

Os status s√£o coloridos automaticamente:
- **Paid/Pago**: Verde
- **Pending/Pendente**: Amarelo
- **Cancelled/Cancelado**: Vermelho
- **Refunded/Reembolsado**: Laranja
- **Outros/Inv√°lido**: Cinza

## Informa√ß√µes de Tr√°fego - Atribui√ß√£o Completa

Cada pedido agora exibe informa√ß√µes completas de atribui√ß√£o, independente do filtro da API:

### üîÑ √öltimo Clique N√£o Direto (Atribui√ß√£o Atual)
- **Categoria de Tr√°fego**: Emoji + nome (ex: üü¢ Google Ads)
- **Origem**: Fonte do tr√°fego (google, facebook, etc.)
- **M√≠dia**: Tipo de an√∫ncio (cpc, cpm, etc.)
- **Campanha**: Nome da campanha espec√≠fica
- **Conte√∫do**: Conte√∫do do an√∫ncio
- **P√°gina de Entrada**: URL da p√°gina de convers√£o

### üéØ Primeiro Clique
- **Categoria de Tr√°fego**: Primeira intera√ß√£o do usu√°rio
- **Origem**: Primeira fonte de tr√°fego
- **M√≠dia**: Primeiro tipo de an√∫ncio visto
- **Campanha**: Primeira campanha que gerou interesse
- **Conte√∫do**: Primeiro conte√∫do visualizado
- **P√°gina de Entrada**: Primeira p√°gina visitada

### üìû Primeiro Lead (quando dispon√≠vel)
- **Categoria de Tr√°fego**: Fonte do primeiro lead
- **Origem**: Origem do lead
- **M√≠dia**: Tipo de an√∫ncio que gerou o lead
- **Campanha**: Campanha que capturou o lead
- **Conte√∫do**: Conte√∫do que gerou o lead
- **P√°gina de Entrada**: P√°gina onde o lead foi capturado

### üìä Compara√ß√£o Visual
- **Layout lado a lado**: Compara√ß√£o direta entre primeiro clique e √∫ltimo clique n√£o direto
- **Indicador de diferen√ßa**: Alerta quando as fontes s√£o diferentes
- **Gradiente visual**: Diferencia√ß√£o por cores (azul/verde)
- **An√°lise r√°pida**: Identifica√ß√£o visual de mudan√ßas de atribui√ß√£o

### üîç Filtro de Atribui√ß√£o Diferente
- **Checkbox no header**: "Apenas atribui√ß√µes diferentes"
- **Filtro inteligente**: Mostra apenas pedidos onde primeiro ‚â† √∫ltimo clique
- **Contador din√¢mico**: "X de Y" quando filtro est√° ativo
- **Mensagem espec√≠fica**: Quando n√£o h√° pedidos com atribui√ß√£o diferente
- **An√°lise de jornada**: Identifica mudan√ßas de fonte de tr√°fego

## Responsividade e Scroll

O modal √© totalmente responsivo e otimizado para scroll:
- **Desktop**: Modal grande com scroll interno otimizado
- **Mobile**: Modal que ocupa quase toda a tela
- **Scroll interno**: √Årea de conte√∫do com scroll independente
- **Indicador visual**: Mostra quando h√° mais de 5 pedidos para rolar
- **Scroll suave**: Transi√ß√µes suaves durante a rolagem
- **Header fixo**: Header permanece vis√≠vel durante o scroll
- **Adapta√ß√£o autom√°tica**: Conte√∫do se adapta ao tamanho da tela

## Performance e Otimiza√ß√µes

### Sistema de Cache
- Cache de 5 minutos para dados j√° carregados
- **Cache por modelo de atribui√ß√£o**: Diferentes caches para √öltimo Clique N√£o Direto vs Primeiro Clique
- Evita requisi√ß√µes desnecess√°rias
- Melhora significativamente a velocidade de carregamento

### Carregamento em Background
- Dados s√£o carregados sem bloquear a interface
- Indicador sutil de atualiza√ß√£o
- Usu√°rio pode interagir enquanto dados carregam

### Cancelamento de Requisi√ß√µes
- AbortController para cancelar requisi√ß√µes antigas
- Evita race conditions
- Melhora performance em mudan√ßas r√°pidas de filtros

### Otimiza√ß√µes de UX
- **Sistema de download primeiro**: Evita carregamento lento no modal
- **Estados visuais claros**: Download ‚Üí Loading ‚Üí Pronto
- **Tooltip din√¢mico**: Informa√ß√µes espec√≠ficas para cada estado
- **Indicador visual**: Cores e √≠cones diferentes para cada estado
- **Bot√£o de refresh**: Para atualiza√ß√£o manual no modal
- **Cache inteligente**: Dados persistidos entre sess√µes
- **Limpeza autom√°tica**: Cache limpo ao mudar filtros

## Seguran√ßa

- Token de autentica√ß√£o obrigat√≥rio
- Valida√ß√£o de par√¢metros
- Tratamento de erros de API
- Logout autom√°tico em caso de token inv√°lido

## Uso

1. Acesse a aba "Vis√£o Geral" no dashboard
2. Selecione as datas desejadas
3. Na tabela, procure uma linha com pedidos > 0
4. **Primeiro**: Clique no √≠cone de download (‚¨áÔ∏è) na coluna "Pedidos"
5. **Aguarde**: O √≠cone mostra loading enquanto baixa os dados
6. **Depois**: O √≠cone muda para olho verde (üëÅÔ∏è) indicando dados prontos
7. **Visualizar**: Clique no √≠cone de olho para abrir o modal
8. **Filtrar (opcional)**: Marque "Apenas atribui√ß√µes diferentes" para ver pedidos com jornadas diferentes
9. **Resultado**: Visualize os detalhes dos pedidos no modal
10. Feche o modal clicando no X ou fora dele

## Estados do Bot√£o

### 1. Download (‚¨áÔ∏è)
- **Cor**: Azul
- **A√ß√£o**: Baixar pedidos
- **Tooltip**: "Baixar X pedidos"

### 2. Loading (üîÑ)
- **Cor**: Azul com spinner
- **A√ß√£o**: Nenhuma (desabilitado)
- **Tooltip**: "Baixando pedidos..."

### 3. Pronto (üëÅÔ∏è)
- **Cor**: Verde com indicador
- **A√ß√£o**: Abrir modal
- **Tooltip**: "Ver X pedidos baixados" 